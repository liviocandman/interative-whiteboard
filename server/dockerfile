# Multi-stage build otimizado para produção
FROM node:20-alpine AS base

# Instalar dumb-init para proper signal handling
RUN apk add --no-cache dumb-init

WORKDIR /app

# Criar usuário não-root
RUN addgroup -g 1001 -S nodejs && \
    adduser -S whiteboard -u 1001

# ==========================================
# Dependencies stage
# ==========================================
FROM base AS deps

# Copiar apenas arquivos de dependências
COPY package.json package-lock.json ./

# Instalar todas as dependências (incluindo devDependencies para build)
RUN npm ci --include=dev && \
    npm cache clean --force

# ==========================================
# Build stage  
# ==========================================
FROM base AS build

# Copiar node_modules da stage anterior
COPY --from=deps /app/node_modules ./node_modules
COPY package.json package-lock.json ./

# Copiar código fonte
COPY src ./src
COPY tsconfig.json ./
COPY .swcrc ./

# Build da aplicação
RUN npm run build